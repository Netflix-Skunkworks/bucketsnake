<html><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1"/><title>Deploying the Bucket Snake Lambda Function · Bucket Snake</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta property="og:title" content="Deploying the Bucket Snake Lambda Function · Bucket Snake"/><meta property="og:type" content="website"/><meta property="og:url" content="https://github.com/Netflix-Skunkworks/bucketsnake/bucketsnake/index.html"/><meta property="og:description" content="Bucket Snake can be deployed with [Serverless](https://serverless.com). See the [docs/serverless-examples](https://github.com/Netflix-Skunkworks/bucketsnake/tree/master/docs/serverless-examples) for an example."/><link rel="shortcut icon" href="/bucketsnake/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/bucketsnake/css/main.css"/></head><body class="sideNavVisible"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/bucketsnake/"><img class="logo" src="/bucketsnake/img/logo.png"/><h2 class="headerTitle">Bucket Snake</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li><a href="/bucketsnake/docs/intro.html" target="_self">Docs</a></li><li><a href="https://github.com/Netflix-Skunkworks/bucketsnake" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>Installation &amp; Configuration</span></h2></div><div class="navGroups"><div class="navGroup navGroupActive"><h3>Introduction &amp; Background</h3><ul><li class="navListItem"><a class="navItem" href="/bucketsnake/docs/intro.html">Introduction</a></li><li class="navListItem"><a class="navItem" href="/bucketsnake/docs/s3background.html">S3 Background</a></li><li class="navListItem"><a class="navItem" href="/bucketsnake/docs/howitworks.html">How it works</a></li><li class="navListItem"><a class="navItem" href="/bucketsnake/docs/permissions.html">Permission Reference</a></li></ul></div><div class="navGroup navGroupActive"><h3>Installation &amp; Configuration</h3><ul><li class="navListItem navListItemActive"><a class="navItem navItemActive" href="/bucketsnake/docs/installation.html">Deployment</a></li><li class="navListItem"><a class="navItem" href="/bucketsnake/docs/configuration.html">Configuration</a></li></ul></div></div></section></div><script>
          var toggler = document.getElementById('navToggler');
          var nav = document.getElementById('docsNav');
          toggler.onclick = function() {
            nav.classList.toggle('docsSliderActive');
          };
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1>Deploying the Bucket Snake Lambda Function</h1></header><article><div><span><p>Bucket Snake can be deployed with <a href="https://serverless.com">Serverless</a>. See the <a href="https://github.com/Netflix-Skunkworks/bucketsnake/tree/master/docs/serverless-examples">docs/serverless-examples</a> for an example.</p>
<h2><a class="anchor" aria-hidden="true" name="what-is-required"></a><a href="#what-is-required" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What is required?</h2>
<p>Bucket Snake depends on <a href="https://github.com/Netflix-Skunkworks/swag-api">SWAG</a>, <a href="https://github.com/Netflix-Skunkworks/historical">Historical</a>, and the <a href="https://github.com/Netflix-Skunkworks/historical-reports">Historical S3 Report</a>.</p>
<p>For a summary of these tools, please visit their respective pages and review the documentation.</p>
<h3><a class="anchor" aria-hidden="true" name="historical-s3-report"></a><a href="#historical-s3-report" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Historical S3 Report</h3>
<p>Bucket Snake has a hard dependency on the Historical S3 Report, which is provided as part of the <a href="https://github.com/Netflix-Skunkworks/historical-reports">Historical-Reports</a>.</p>
<p>Bucket Snake doesn't require much from the report. It requires:</p>
<ol>
<li>The bucket name</li>
<li>The bucket region</li>
<li>The bucket account</li>
</ol>
<p>This can be achieved with a Historical S3 report that has the <code>EXCLUDE_FIELDS</code> environmental variable configured with the value:</p>
<pre><code class="hljs">Name,_version,Grants,LifecycleRules,Logging,Policy,Tags,Versioning,Website,Cors,Notifications,Acceleration,Replication,CreationDate,AnalyticsConfigurations,MetricsConfigurations,InventoryConfigurations
</code></pre>
<p>A slim report is not required -- but it makes for a smaller JSON file for client applications to fetch from S3 (or have included with their deployment).</p>
<h4><a class="anchor" aria-hidden="true" name="historical-report-bucket"></a><a href="#historical-report-bucket" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Historical Report Bucket</h4>
<p>An S3 Bucket that contains this report must be available for the Bucket Snake lambda function. This is required to be set in the configuration. (See the next section for details)</p>
<p>The Historical S3 report should live in a bucket that all applications in your infrastructure can access. This will allow applications to fetch this file to make a determination if cross-account access is required.</p>
<h3><a class="anchor" aria-hidden="true" name="swag"></a><a href="#swag" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SWAG</h3>
<p>SWAG is a hard requirement for Bucket Snake. The JSON must be accessible in S3 and is configurable. (See the next section for details)</p>
<h2><a class="anchor" aria-hidden="true" name="iam-roles"></a><a href="#iam-roles" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>IAM Roles</h2>
<p>Bucket Snake operates from a hub-spoke type of model. The lambda function itself requires an IAM role, which then assumes into other account IAM roles to provision the S3 access for a given application.</p>
<p>Please use your favorite tool to sync these roles out across your environment.</p>
<h4><a class="anchor" aria-hidden="true" name="bucket-snake-lambda-function-iam-role"></a><a href="#bucket-snake-lambda-function-iam-role" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Bucket Snake Lambda Function IAM Role</h4>
<p>The trust policy must be similar to:</p>
<pre><code class="hljs">{
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: &quot;sts:AssumeRole&quot;,
            &quot;Principal&quot;: {
                &quot;Service&quot;: &quot;lambda.amazonaws.com&quot;
            }
        }
    ]
}
</code></pre>
<p>The inline-polices must be similar to:</p>
<pre><code class="hljs">{
    &quot;Statement&quot;: [
        {
            &quot;Sid&quot;: &quot;Logs&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;logs:CreateLogGroup&quot;,
                &quot;logs:CreateLogStream&quot;,
                &quot;logs:PutLogEvents&quot;
            ],
            &quot;Resource&quot;: &quot;*&quot;
        },
        {
            &quot;Sid&quot;: &quot;HistoricalS3&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: &quot;s3:GetObject&quot;,
            &quot;Resource&quot;: &quot;arn:aws:s3:::historical-s3-report-bucket/prefix/to/historical-s3-reports.json&quot;
        },
        {
            &quot;Sid&quot;: &quot;AssumeToRoles&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: &quot;sts:AssumeRole&quot;,
            &quot;Resource&quot;: &quot;arn:aws:iam::*:role/BucketSnake&quot;
        }
    ]
}
</code></pre>
<h4><a class="anchor" aria-hidden="true" name="in-account-bucket-snake-iam-role-destination-roles"></a><a href="#in-account-bucket-snake-iam-role-destination-roles" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>In-account Bucket Snake IAM Role (Destination Roles)</h4>
<p>The trust policy must be similar to:</p>
<pre><code class="hljs">{
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: &quot;sts:AssumeRole&quot;,
            &quot;Principal&quot;: {
                &quot;AWS&quot;: &quot;arn:aws:iam::SOURCE-BUCKET-SNAKE-LAMBDA-ACCOUNT-HERE:role/BucketSnakeLambdaProfile&quot;
            }
        }
    ]
}
</code></pre>
<p>The inline-polices must be similar to:</p>
<pre><code class="hljs">{
    &quot;Statement&quot;: [
        {
            &quot;Action&quot;: [
                &quot;iam:CreateRole&quot;,
                &quot;iam:GetRole&quot;,
                &quot;iam:PutRolePolicy&quot;,
                &quot;iam:UpdateAssumeRolePolicy&quot;
            ],
            &quot;Resource&quot;: &quot;*&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;
        }
    ]
}
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="permissions.html">← Bucket Snake S3 Permissions</a><a class="docs-next button" href="configuration.html">Configuring the Bucket Snake Lambda Function →</a></div></div></div></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/bucketsnake/" class="nav-home"><img src="/bucketsnake/img/logo.png" alt="Bucket Snake" width="66" height="58"/></a><div><h5>Background</h5><a href="/bucketsnake/docs/intro.html">Introduction</a><a href="/bucketsnake/docs/s3background.html">General S3 Background</a><a href="/bucketsnake/docs/howitworks.html">How Bucket Snake Works</a></div><div><h5>Getting Started</h5><a href="/bucketsnake/docs/installation.html">Installation</a><a href="/bucketsnake/docs/configuration.html">Configuration</a></div><div><h5>Community</h5><a href="https://github.com/Netflix-Skunkworks/bucketsnake">GitHub</a></div></section><section class="copyright">These docs were created with <a href="https://docusaurus.io/">Docusaurus</a>.</section><section class="copyright" style="padding-top:10px;">Copyright © 2017 Netflix, Inc.</section></footer></div></body></html>